<!DOCTYPE html>
<html prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="A Faster Python">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PyPy</title>
<link href="../assets/css/rst_base.css" rel="stylesheet" type="text/css">
<link href="../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../assets/css/styles.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../rss.xml">
<link rel="canonical" href="https://www.pypy.org/blog/">
<link rel="icon" href="../favicon2.ico" sizes="16x16">
<link rel="icon" href="../favicon32x32.ico" sizes="32x32">
<link rel="next" href="index-41.html" type="text/html">
<!--[if lt IE 9]><script src="../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="../assets/css/tipuesearch.css">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
             <header id="header"><!-- Adapted from https://www.taniarascia.com/responsive-dropdown-navigation-bar --><section class="navigation"><div class="nav-container">
            <div class="brand">
                <a href="../index.html">
                    <image id="toplogo" src="../images/pypy-logo.svg" width="75px;" alt="PyPy/"></image></a>
            </div>
            <nav><ul class="nav-list">
<li> 
                <a href="#!">Features</a>
                <ul class="nav-dropdown">
<li> <a href="../features.html">What is PyPy?</a> </li>  
                    <li> <a href="../compat.html">Compatibility</a> </li>  
                    <li> <a href="../performance.html">Performance</a> </li>  
                </ul>
</li>
          <li> <a href="../download.html">Download</a> </li>  
          <li> <a href="http://doc.pypy.org">Dev Docs</a> </li>  
            <li> 
                <a href="#!">Blog</a>
                <ul class="nav-dropdown">
<li> <a href="../blog">Index</a> </li>  
                    <li> <a href="../categories">Tags</a> </li>  
                    <li> <a href="../archive.html">Archive by year</a> </li>  
                    <li> <a href="../rss.xml">RSS feed</a> </li>  
                    <li> <a href="https://morepypy.blogspot.com/">Old site</a> </li>  
                </ul>
</li>
            <li> 
                <a href="#!">About</a>
                <ul class="nav-dropdown">
<li> <a href="https://twitter.com/pypyproject">Twitter</a> </li>  
                    <li> <a href="https://libera.irclog.whitequark.org/pypy">IRC logs</a> </li>  
                    <li> <a href="https://www.youtube.com/playlist?list=PLADqad94yVqDRQXuqxKrPS5QnVqbDLlRt">YouTube</a> </li>  
                    <li> <a href="https://www.twitch.tv/pypyproject">Twitch</a> </li>  
                    <li> <a href="../people.html">People</a> </li>  
                    <li> <a href="../howtohelp.html">How To Help?</a> </li>  
                    <li> <a href="../contact.html">Contact</a> </li>  
                </ul>
</li>

                </ul></nav><div class="nav-mobile">
                <a id="nav-toggle" href="#!"> <span></span></a>
            </div>
        </div>
    </section><div class="searchform" role="search">
                
<form class="navbar-form navbar-left" action="../search.html" role="search">
    <div class="form-group">
        <input type="text" class="form-control" id="tipue_search_input" name="q" placeholder="Search‚Ä¶" autocomplete="off">
</div>
    <input type="submit" value="Local Search" style="visibility: hidden;">
</form>

            </div>
    </header><main id="content"><div class="post">
<div class="postindex">
    <article class="h-entry post-rest" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2021/10/pypy-v737-release.html" class="u-url">PyPy v7.3.7: bugfix release of python 3.7 and 3.8</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/the-pypy-team.html">The PyPy Team</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2021/10/pypy-v737-release.html" rel="bookmark">
            <time class="published dt-published" datetime="2021-10-25T05:53:45Z" itemprop="datePublished" title="2021-10-25 05:53">2021-10-25 05:53</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <section id="pypy-v7-3-7-bug-fix-release-of-3-7-3-8"><h2>PyPy v7.3.7: bug-fix release of 3.7, 3.8</h2>
<p>We are releasing a PyPy 7.3.7 to fix the recent 7.3.6 release's binary
incompatibility with the previous 7.3.x releases. We mistakenly added fields
to <code class="docutils literal">PyFrameObject</code> and <code class="docutils literal">PyDateTime_CAPI</code> that broke the promise of binary
compatibility, which means that c-extension wheels compiled for 7.3.5 will not
work with 7.3.6 and via-versa. Please do not use 7.3.6.</p>
<p>We have added a cursory test for binary API breakage to the
<a class="reference external" href="https://github.com/pypy/binary-testing">https://github.com/pypy/binary-testing</a> repo which hopefully will prevent such
mistakes in the future.</p>
<p>Additionally, a few smaller bugs were fixed:</p>
<ul class="simple">
<li><p>Use <code class="docutils literal">uint</code> for the <code class="docutils literal">request</code> argument of <code class="docutils literal">fcntl.ioctl</code> (issue <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/3568">3568</a>)</p></li>
<li><p>Fix incorrect tracing of <cite>while True`</cite> body in 3.8 (issue <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/3577">3577</a>)</p></li>
<li><p>Properly close resources when using a <code class="docutils literal">conncurrent.futures.ProcessPool</code>
(issue <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/3317">3317</a>)</p></li>
<li><p>Fix the value of <code class="docutils literal">LIBDIR</code> in <code class="docutils literal">_sysconfigdata</code> in 3.8 (issue <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/3582">3582</a>)</p></li>
</ul>
<p>You can find links to download the v7.3.7 releases here:</p>
<blockquote>
<p><a class="reference external" href="https://pypy.org/download.html">https://pypy.org/download.html</a></p>
</blockquote>
<p>We would like to thank our donors for the continued support of the PyPy
project. If PyPy is not quite good enough for your needs, we are available for
direct consulting work. If PyPy is helping you out, we would love to hear about
it and encourage submissions to our <a class="reference external" href="https://pypy.org/blog">blog site</a> via a pull request
to <a class="reference external" href="https://github.com/pypy/pypy.org">https://github.com/pypy/pypy.org</a></p>
<p>We would also like to thank our contributors and encourage new people to join
the project. PyPy has many layers and we need help with all of them: <a class="reference external" href="../posts/2021/10/index.html">PyPy</a>
and <a class="reference external" href="https://rpython.readthedocs.org">RPython</a> documentation improvements, tweaking popular modules to run
on PyPy, or general <a class="reference external" href="../posts/2021/10/project-ideas.html">help</a> with making RPython's JIT even better.</p>
<p>If you are a python library maintainer and use C-extensions, please consider
making a <a class="reference external" href="https://cffi.readthedocs.io">CFFI</a> / <a class="reference external" href="https://cppyy.readthedocs.io">cppyy</a> version of your library that would be performant on PyPy.
In any case both <a class="reference external" href="https://github.com/joerick/cibuildwheel">cibuildwheel</a> and the <a class="reference external" href="https://github.com/matthew-brett/multibuild">multibuild system</a> support
building wheels for PyPy.</p>
<section id="what-is-pypy"><h3>What is PyPy?</h3>
<p>PyPy is a Python interpreter, a drop-in replacement for CPython 2.7, 3.7, and
3.8. It's fast (<a class="reference external" href="https://speed.pypy.org">PyPy and CPython 3.7.4</a> performance
comparison) due to its integrated tracing JIT compiler.</p>
<p>We also welcome developers of other <a class="reference external" href="https://rpython.readthedocs.io/en/latest/examples.html">dynamic languages</a> to see what RPython
can do for them.</p>
<p>This PyPy release supports:</p>
<blockquote>
<ul class="simple">
<li><p><strong>x86</strong> machines on most common operating systems
(Linux 32/64 bits, Mac OS X 64 bits, Windows 64 bits, OpenBSD, FreeBSD)</p></li>
<li><p>64-bit <strong>ARM</strong> machines running Linux.</p></li>
<li><p><strong>s390x</strong> running Linux</p></li>
</ul>
</blockquote>
<p>PyPy does support ARM 32 bit and PPC64 processors, but does not release binaries.</p>
</section></section>
</div>
    </article><article class="h-entry post-rest" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2021/10/pypy-v736-release.html" class="u-url">PyPy v7.3.6: release of python 2.7, 3.7, and 3.8</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/the-pypy-team.html">The PyPy Team</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2021/10/pypy-v736-release.html" rel="bookmark">
            <time class="published dt-published" datetime="2021-10-17T05:53:45Z" itemprop="datePublished" title="2021-10-17 05:53">2021-10-17 05:53</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <section id="pypy-v7-3-6-release-of-python-2-7-3-7-and-3-8-beta"><h2>PyPy v7.3.6: release of python 2.7, 3.7, and 3.8-beta</h2>
<p>The PyPy team is proud to release version 7.3.6 of PyPy, which includes
three different interpreters:</p>
<blockquote>
<ul class="simple">
<li><p>PyPy2.7, which is an interpreter supporting the syntax and the features of
Python 2.7 including the stdlib for CPython 2.7.18+ (the <code class="docutils literal">+</code> is for
backported security updates)</p></li>
<li><p>PyPy3.7,  which is an interpreter supporting the syntax and the features of
Python 3.7, including the stdlib for CPython 3.7.12.</p></li>
<li><p>PyPy3.8, which is an interpreter supporting the syntax and the features of
Python 3.8, including the stdlib for CPython 3.8.12. Since this is our
first release of the interpreter, we relate to this as "beta" quality. We
welcome testing of this version, if you discover incompatibilites, please
report them so we can gain confidence in the version.</p></li>
</ul>
</blockquote>
<p>The interpreters are based on much the same codebase, thus the multiple
release. This is a micro release, all APIs are compatible with the other 7.3
releases. Highlights of the release, since the release of 7.3.5 in May 2021,
include:</p>
<blockquote>
<ul class="simple">
<li><p>We have merged a backend for <a class="reference external" href="https://hpyproject.org/">HPy</a>, the better C-API interface. The backend
implements HPy version 0.0.3.</p></li>
<li><p>Translation of PyPy into a binary, known to be slow, is now about 40%
faster. On a modern machine, PyPy3.8 can translate in about 20 minutes.</p></li>
<li><p>PyPy Windows 64 is now available on <a class="reference external" href="https://conda-forge.org/blog//2020/03/10/pypy">conda-forge</a>, along with nearly 700
commonly used binary packages. This new offering joins the more than 1000
conda packages for PyPy on Linux and macOS. Many thanks to the conda-forge
maintainers for pushing this forward over the past 18 months.</p></li>
<li><p>Speed improvements were made to <code class="docutils literal">io</code>, <code class="docutils literal">sum</code>, <code class="docutils literal">_ssl</code> and more. These
were done in response to user feedback.</p></li>
<li><p>The 3.8 version of the release contains a beta-quality improvement to the
JIT to better support <a class="reference external" href="https://www.pypy.org/posts/2021/09/jit-auto-generated-code.html">compiling huge Python functions</a> by breaking them
up into smaller pieces.</p></li>
<li><p>The release of Python3.8 required a concerted effort. We were greatly
helped by @isidentical (Batuhan Taskaya) and other new contributors.</p></li>
<li><p>The 3.8 package now uses the same layout as CPython, and many of the
PyPy-specific changes to <code class="docutils literal">sysconfig</code>, <code class="docutils literal">distutils.sysconfig</code>, and
<code class="docutils literal">distutils.commands.install.py</code> have been removed. The <code class="docutils literal">stdlib</code> now
is located in <code class="docutils literal"><span class="pre">&lt;base&gt;/lib/pypy3.8</span></code> on <code class="docutils literal">posix</code> systems, and in
<code class="docutils literal"><span class="pre">&lt;base&gt;/Lib</span></code> on Windows. The include files on windows remain the same.
On <code class="docutils literal">posix</code> they are in <code class="docutils literal"><span class="pre">&lt;base&gt;/include/pypy3.8</span></code>. Note we still use the
<code class="docutils literal">pypy</code> prefix to prevent mixing the files with CPython (which uses
<code class="docutils literal">python</code>.</p></li>
</ul>
</blockquote>
<p>We recommend updating. You can find links to download the v7.3.6 releases here:</p>
<blockquote>
<p><a class="reference external" href="https://pypy.org/download.html">https://pypy.org/download.html</a></p>
</blockquote>
<p>We would like to thank our donors for the continued support of the PyPy
project. If PyPy is not quite good enough for your needs, we are available for
direct consulting work. If PyPy is helping you out, we would love to hear about
it and encourage submissions to our <a class="reference external" href="https://pypy.org/blog">blog</a> via a pull request
to <a class="reference external" href="https://github.com/pypy/pypy.org">https://github.com/pypy/pypy.org</a></p>
<p>We would also like to thank our contributors and encourage new people to join
the project. PyPy has many layers and we need help with all of them: <a class="reference external" href="https://pypy.org">PyPy</a>
and <a class="reference external" href="https://rpython.readthedocs.org">RPython</a> documentation improvements, tweaking popular modules to run
on PyPy, or general <a class="reference external" href="https://doc.pypy.org/en/latest/project-ideas.html">help</a> with making RPython's JIT even better. Since the
previous release, we have accepted contributions from 7 new contributors,
thanks for pitching in, and welcome to the project!</p>
<p>If you are a python library maintainer and use C-extensions, please consider
making a <a class="reference external" href="https://cffi.readthedocs.io">CFFI</a> / <a class="reference external" href="https://cppyy.readthedocs.io">cppyy</a> version of your library that would be performant on PyPy.
In any case both <a class="reference external" href="https://github.com/joerick/cibuildwheel">cibuildwheel</a> and the <a class="reference external" href="https://github.com/matthew-brett/multibuild">multibuild system</a> support
building wheels for PyPy.</p>
<section id="what-is-pypy"><h3>What is PyPy?</h3>
<p>PyPy is a Python interpreter, a drop-in replacement for CPython 2.7, 3.7, and
soon 3.8. It's fast (<a class="reference external" href="https://speed.pypy.org">PyPy and CPython 3.7.4</a> performance
comparison) due to its integrated tracing JIT compiler.</p>
<p>We also welcome developers of other <a class="reference external" href="https://rpython.readthedocs.io/en/latest/examples.html">dynamic languages</a> to see what RPython
can do for them.</p>
<p>This PyPy release supports:</p>
<blockquote>
<ul class="simple">
<li><p><strong>x86</strong> machines on most common operating systems
(Linux 32/64 bits, Mac OS X 64 bits, Windows 64 bits, OpenBSD, FreeBSD)</p></li>
<li><p>big- and little-endian variants of <strong>PPC64</strong> running Linux,</p></li>
<li><p><strong>s390x</strong> running Linux</p></li>
<li><p>64-bit <strong>ARM</strong> machines running Linux.</p></li>
</ul>
</blockquote>
<p>PyPy does support Windows 32-bit and ARM 32 bit processors, but does not
release binaries. Please reach out to us if you wish to sponsor releases for
those platforms.</p>
</section><section id="what-else-is-new"><h3>What else is new?</h3>
<p>For more information about the 7.3.6 release, see the <a class="reference external" href="https://doc.pypy.org/en/latest/release-v7.3.6.html#changelog">full changelog</a>.</p>
<p>Please update, and continue to help us make PyPy better.</p>
<p>Cheers,
The PyPy team</p>
</section></section>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2021/09/jit-auto-generated-code.html" class="u-url">Better JIT Support for Auto-Generated Python Code</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2021/09/jit-auto-generated-code.html" rel="bookmark">
            <time class="published dt-published" datetime="2021-09-17T19:55:09Z" itemprop="datePublished" title="2021-09-17 19:55">2021-09-17 19:55</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <div>
<h2>Performance Cliffs</h2>
<p>A common bad property of many different JIT compilers is that of a "performance
cliff": A seemingly reasonable code change, leading to massively reduced
performance due to hitting some weird property of the JIT compiler that's not
easy to understand for the programmer (e.g. here's a blog post about the fix of
a performance cliff when running <a href="https://v8.dev/blog/react-cliff">React on
V8</a>). Hitting a performance cliff as a
programmer can be intensely frustrating and turn people off from using PyPy
altogether. Recently we've been working on trying to remove some of PyPy's
performance cliffs, and this post describes one such effort.</p>
<p>The problem showed up in an <a href="https://foss.heptapod.net/pypy/pypy/-/issues/3402">issue</a>
where somebody found the performance
of their website using <a href="https://www.tornadoweb.org/en/stable/">Tornado</a> a lot
worse than what various benchmarks suggested. It took some careful digging to
figure out what caused the problem: The slow performance was caused by the huge
functions that the Tornado templating engine creates. These functions lead the
JIT to behave in unproductive ways. In this blog post I'll describe why the
problem occurs and how we fixed it.</p>
<h2>Problem</h2>
<p>After quite a bit of debugging we narrowed down the problem to the following
reproducer: If you render a big HTML template
(<a href="https://gist.github.com/cfbolz/4a346d104fee41affc860a7b928b7291#file-index-html">example</a>)
using the Tornado templating engine, the template rendering is really not any
faster than CPython. A small template doesn't show this behavior, and other
parts of Tornado seem to perform well. So we looked into how the templating
engine works, and it turns out that the templates are compiled into Python
functions. This means that a big template can turn into a really enormous Python
function (<a href="https://gist.github.com/cfbolz/4a346d104fee41affc860a7b928b7291#file-zz_autogenerated-py">Python version of the
example</a>).
For some reason really enormous Python functions aren't handled particularly
well by the JIT, and in the next section I'll explain some the background that's
necessary to understand why this happens.</p>
<h2>Trace Limits and Inlining</h2>
<p>To understand why the problem occurs, it's necessary to understand how PyPy's
trace limit and inlining works. The tracing JIT has a maximum trace length built
in, the reason for that is some limitation in the compact encoding of traces in
the JIT. Another reason is that we don't want to generate arbitrary large chunks
of machine code. Usually, when we hit the trace limit, it is due to <em>inlining</em>.
While tracing, the JIT will inline many of the functions called from the
outermost one. This is usually good and improves performance greatly, however,
inlining can also lead to the trace being too long. If that happens, we
will mark a called function as uninlinable. The next time we trace the outer
function we won't inline it, leading to a shorter trace, which hopefully fits
the trace limit.</p>
<p><img alt="Diagram illustrating the interaction of the trace limit and inlining" src="../images/2021-open-ended-traces-01-inlining.svg"></p>
<p>In the diagram above we trace a function <code>f</code>, which calls a function <code>g</code>, which
is inlined into the trace. The trace ends up being too long, so the JIT
disables inlining of <code>g</code>. The next time we try to trace <code>f</code> the trace will
contain a <em>call</em> to <code>g</code> instead of inlining it. The trace ends up being not too
long, so we can turn it into machine code when tracing finishes.</p>
<p>Now we know enough to understand what the problem with automatically generated
code is: sometimes, the outermost function itself
doesn't fit the trace limit, without any inlining going on at all. This is
usually not the case for normal, hand-written Python functions. However, it can
happen for automatically generated Python code, such as the code that the
Tornado templating engine produces.</p>
<p>So, what happens when the JIT hits such a huge function? The function is traced
until the trace is too long. Then the trace limits stops further tracing. Since
nothing was inlined, we cannot make the trace shorter the next time by disabling
inlining. Therefore, this happens again and again, the next time we trace the
function we run into exactly the same problem. The net effect is that the
function is even slowed down: we spend time tracing it, then stop tracing and
throw the trace away. Therefore, that effort is never useful, so the resulting
execution can be slower than not using the JIT at all!</p>
<h2>Solution</h2>
<p>To get out of the endless cycle of useless retracing we first had the idea of
simply disabling all code generation for such huge functions, that produce too long
traces even if there is no inlining at all. However, that lead to disappointing
performance in the example Tornado program, because important parts of the code
remain always interpreted.</p>
<p>Instead, our solution is now as follows: After we have hit the trace limit and
no inlining has happened so far, we mark the outermost function as a source of huge
traces. The next time we trace such a function, we do so in a special mode. In
that mode, hitting the trace limit behaves differently: Instead of stopping the
tracer and throwing away the trace produced so far, we will use the unfinished
trace to produce machine code. This trace corresponds to the first part of the
function, but stops at a basically arbitrary point in the middle of the
function.</p>
<p>The question is what should happen when execution
reaches the end of this unfinished trace. We want to be able to cover more of
the function with machine code and therefore need to extend the trace
from that point on. But we don't want to do that too
eagerly to prevent lots and lots of machine code being generated. To achieve
this behaviour we add a guard to the end of the unfinished trace, which will
always fail. This has the right behaviour: a failing guard will transfer control
to the interpreter, but if it fails often enough, we can patch it to jump to
more machine code, that starts from this position. In that way, we can slowly
explore the full gigantic function and add all those parts of the control flow
graph that are actually commonly executed at runtime.</p>
<p><img alt="Diagram showing what happens in the new jit when tracing a huge function" src="../images/2021-open-ended-traces-02-no-inlining.svg"></p>
<p>In the diagram we are trying to trace a huge function <code>f</code>, which leads to
hitting the trace limit. However, nothing was inlined into the trace, so
disabling inlining won't ensure a successful trace attempt the next time.
Instead, we mark <code>f</code> as "huge". This has the effect that when we trace it again
and are about to hit the trace limit, we end the trace at an arbitrary point by
inserting a guard that always fails.</p>
<p><img alt="Diagram showing what happens in the new jit when tracing a huge function until completion" src="../images/2021-open-ended-traces-03-complete.svg"></p>
<p>If this guard failure is executed often enough, we might patch the guard and
add a jump to a further part of the function <code>f</code>. This can continue potentially
several times, until the trace really hits and end points (for example by
closing the loop and jumping back to trace 1, or by returning from <code>f</code>).</p>
<h2>Evaluation</h2>
<p>Since this is a performance cliff that we didn't observe in any of our
<a href="http://speed.pypy.org/">benchmarks</a> ourselves, it's pointless to look at the
effect that this improvement has on existing benchmarks ‚Äì there shouldn't and
indeed there isn't any.</p>
<p>Instead, we are going to look at a micro-benchmark that came out of the
original bug report, one that simply renders a big artificial Tornado template
200 times. The code of the micro-benchmark can be found
<a href="https://gist.github.com/cfbolz/4a346d104fee41affc860a7b928b7291">here</a>.</p>
<p>All benchmarks were run 10 times in new processes. The means and standard
deviations of the benchmark runs are:</p>
<table>
<thead><tr>
<th>Implementation</th>
<th align="right">Time taken (lower is better)</th>
</tr></thead>
<tbody>
<tr>
<td>CPython 3.9.5</td>
<td align="right">14.19 ¬± 0.35s</td>
</tr>
<tr>
<td>PyPy3 without JIT</td>
<td align="right">59.48 ¬± 5.41s</td>
</tr>
<tr>
<td>PyPy3 JIT old</td>
<td align="right">14.47 ¬± 0.35s</td>
</tr>
<tr>
<td>PyPy3 JIT new</td>
<td align="right">4.89 ¬± 0.10s</td>
</tr>
</tbody>
</table>
<p>What we can see is that while the old JIT is very helpful for this
micro-benchmark, it only brings the performance up to CPython levels, not
providing any extra benefit. The new JIT gives an almost 3x speedup.</p>
<p>Another interesting number we can look at is how often the JIT started a trace,
and for how many traces we produced actual machine code:</p>
<table>
<thead><tr>
<th>Implementation</th>
<th align="right">Traces Started</th>
<th align="right">Traces sent to backend</th>
<th align="right">Time spent in JIT</th>
</tr></thead>
<tbody>
<tr>
<td>PyPy3 JIT old</td>
<td align="right">216</td>
<td align="right">24</td>
<td align="right">0.65s</td>
</tr>
<tr>
<td>PyPy3 JIT new</td>
<td align="right">30</td>
<td align="right">25</td>
<td align="right">0.06s</td>
</tr>
</tbody>
</table>
<p>Here we can clearly see the problem: The old JIT would try tracing the
auto-generated templating code again and again, but would never actually produce
any machine code, wasting lots of time in the process. The new JIT still traces a
few times uselessly, but then eventually converges and stops emitting machine
code for all the paths through the auto-generated Python code.</p>
<!--
1: /home/cfbolz/projects/small-commits-pypy/pypy/goal/pypy-c-38-jit-chunked-traces -jit off render.py
            Mean        Std.Dev.    Min         Median      Max
real        59.479      5.411       51.864      59.966      67.721      
user        59.395      5.383       51.821      59.859      67.585      
sys         0.058       0.034       0.020       0.056       0.108

1: pypy3 render.py
            Mean        Std.Dev.    Min         Median      Max
real        14.469      0.352       13.744      14.472      15.174      
user        14.399      0.359       13.671      14.402      15.126      
sys         0.050       0.034       0.024       0.042       0.148

Tracing:        216 0.653033
Backend:        24  0.003664
TOTAL:              14.854610
ops:                2217432
heapcached ops:     701575
recorded ops:       643513
  calls:            60038
guards:             330245
opt ops:            1876
opt guards:         465
opt guards shared:  237
forcings:           0
abort: trace too long:  191
abort: compiling:   0
abort: vable escape:    0
abort: bad loop:    0
abort: force quasi-immut:   1
nvirtuals:          391
nvholes:            122
nvreused:           141
vecopt tried:       0
vecopt success:     0
Total # of loops:   17
Total # of bridges: 8
Freed # of loops:   5
Freed # of bridges: 5


1: /home/cfbolz/projects/small-commits-pypy/pypy/goal/pypy-c-38-jit-chunked-traces render.py
            Mean        Std.Dev.    Min         Median      Max
real        4.892       0.098       4.718       4.882       5.118       
user        4.807       0.097       4.644       4.797       5.022       
sys         0.067       0.019       0.040       0.070       0.096


Tracing:        30  0.060128
Backend:        25  0.033536
TOTAL:              4.551791
ops:                124584
heapcached ops:     53962
recorded ops:       33486
  calls:            4389
guards:             14061
opt ops:            18922
opt guards:         4281
opt guards shared:  2248
forcings:           0
abort: trace too long:  4
abort: compiling:   0
abort: vable escape:    0
abort: bad loop:    0
abort: force quasi-immut:   1
abort: segmenting trace:    5
nvirtuals:          314
nvholes:            90
nvreused:           114
vecopt tried:       0
vecopt success:     0
Total # of loops:   14
Total # of bridges: 12
Freed # of loops:   0
Freed # of bridges: 0

-->

<h2>Related Work</h2>
<p><a href="https://www.timfelgentreff.de/">Tim Felgentreff</a> pointed me to the fact that
Truffle also has a
<a href="https://www.graalvm.org/truffle/javadoc/com/oracle/truffle/api/nodes/BlockNode.html">mechanism</a>
to slice huge methods into smaller compilation units (and I am sure other JITs
have such mechanisms as well).</p>
<h2>Conclusion</h2>
<p>In this post we've described a performance cliff in PyPy's JIT, that of really
big auto-generated functions which hit the trace limit without inlining, that we
still want to generate machine code for. We achieve this by chunking up the
trace into several smaller traces, which we compile piece by piece. This is not
a super common thing to be happening ‚Äì otherwise we would have run into and
fixed it earlier ‚Äì but it's still good to have a fix now.</p>
<p>The work
described in this post tiny bit experimental still, but we will release it as
part of the upcoming 3.8 beta release, to get some more experience with it.
Please grab a <a href="https://mail.python.org/pipermail/pypy-dev/2021-September/016214.html">3.8 release
candidate</a>,
try it out and let us know your observations, good and bad!</p>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2021/05/pypy-irc-moves-to-libera-chat.html" class="u-url">#pypy IRC moves to Libera.Chat</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/antocuni.html">antocuni</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2021/05/pypy-irc-moves-to-libera-chat.html" rel="bookmark">
            <time class="published dt-published" datetime="2021-05-31T10:00:00Z" itemprop="datePublished" title="2021-05-31 10:00">2021-05-31 10:00</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <div>
<p>Following the example of many other FOSS projects, the PyPy team has
decided to move its official <code>#pypy</code> IRC channel from Freenode to
<a href="https://libera.chat/">Libera.Chat</a>: <a href="irc://irc.libera.chat/pypy">irc.libera.chat/pypy</a></p>
<p>The core devs will no longer be present on the Freenode channel, so we recommend to
join the new channel as soon as possible.</p>
<p>wikimedia.org has a
<a href="https://meta.wikimedia.org/wiki/IRC/Migrating_to_Libera_Chat">nice guide</a> on
how to setup your client to migrate from Freenode to Libera.Chat.</p>
<p class="more"><a href="../posts/2021/05/pypy-irc-moves-to-libera-chat.html">Read more‚Ä¶</a></p>
</div>
    </div>
    </article><article class="h-entry post-rest" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2021/05/pypy-v735-release.html" class="u-url">PyPy v7.3.5: bugfix release of python 2.7 and 3.7</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/the-pypy-team.html">The PyPy Team</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2021/05/pypy-v735-release.html" rel="bookmark">
            <time class="published dt-published" datetime="2021-05-23T05:53:45Z" itemprop="datePublished" title="2021-05-23 05:53">2021-05-23 05:53</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <section id="pypy-v7-3-5-release-of-2-7-and-3-7"><h2>PyPy v7.3.5: release of 2.7 and 3.7</h2>
<p>We are releasing a PyPy 7.3.5 with bugfixes for PyPy 7.3.4, released April 4.
PyPy 7.3.4 was the first release that runs on windows 64-bit, so that support
is still "beta". We are releasing it in the hopes that we can garner momentum
for its continued support, but are already aware of some problems, for instance
it errors in the NumPy test suite (issue <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/3462">3462</a>). Please help out with testing
the releae and reporting successes and failures, financially supporting our
ongoing work, and helping us find the source of these problems.</p>
<ul class="simple">
<li><p>The new windows 64-bit builds improperly named c-extension modules
with the same extension as the 32-bit build (issue <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/3443">3443</a>)</p></li>
<li><p>Use the windows-specific <code class="docutils literal">PC/pyconfig.h</code> rather than the posix one</p></li>
<li><p>Fix the return type for <code class="docutils literal">_Py_HashDouble</code> which impacts 64-bit windows</p></li>
<li><p>A change to the python 3.7 <code class="docutils literal"><span class="pre">sysconfig.get_config_var('LIBDIR')</span></code> was wrong,
leading to problems finding <cite>libpypy3-c.so</cite> for embedded PyPy (issue <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/3442">3442</a>).</p></li>
<li><p>Instantiate <code class="docutils literal">distutils.command.install</code> schema for PyPy-specific
<code class="docutils literal">implementation_lower</code></p></li>
<li><p>Delay thread-checking logic in greenlets until the thread is actually started
(continuation of issue <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/3441">3441</a>)</p></li>
<li>
<p>Four upstream (CPython) security patches were applied:</p>
<ul>
<li><p><a class="reference external" href="https://bugs.python.org/issue42988">BPO 42988</a> to remove <code class="docutils literal">pydoc.getfile</code></p></li>
<li><p><a class="reference external" href="https://bugs.python.org/issue43285">BPO 43285</a> to not trust the <code class="docutils literal">PASV</code> response in <code class="docutils literal">ftplib</code>.</p></li>
<li><p><a class="reference external" href="https://bugs.python.org/issue43075">BPO 43075</a> to remove a possible ReDoS in <code class="docutils literal">urllib</code> <code class="docutils literal">AbstractBasicAuthHandler</code></p></li>
<li><p><a class="reference external" href="https://bugs.python.org/issue43882">BPO 43882</a> to sanitize urls containing ASCII newline and tabs in
<code class="docutils literal">urllib.parse</code></p></li>
</ul>
</li>
<li><p>Fix for json-specialized dicts (issue <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/3460">3460</a>)</p></li>
<li><p>Specialize <code class="docutils literal">ByteBuffer.setslice</code> which speeds up binary file reading by a
factor of 3</p></li>
<li><p>When assigning the full slice of a list, evaluate the rhs before clearing the
list (issue <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/3440">3440</a>)</p></li>
<li><p>On Python2, <code class="docutils literal">PyUnicode_Contains</code> accepts bytes as well as unicode.</p></li>
<li><p>Finish fixing <code class="docutils literal">_sqlite3</code> - untested <code class="docutils literal">_reset()</code> was missing an argument
(issue <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/3432">3432</a>)</p></li>
<li><p>Update the packaged sqlite3 to 3.35.5 on windows. While not a bugfix, this
seems like an easy win.</p></li>
</ul>
<p>We recommend updating. These fixes are the direct result of end-user bug
reports, so please continue reporting issues as they crop up.</p>
<p>You can find links to download the v7.3.5 releases here:</p>
<blockquote>
<p><a class="reference external" href="https://pypy.org/download.html">https://pypy.org/download.html</a></p>
</blockquote>
<p>We would like to thank our donors for the continued support of the PyPy
project. If PyPy is not quite good enough for your needs, we are available for
direct consulting work. If PyPy is helping you out, we would love to hear about
it and encourage submissions to our <a class="reference external" href="https://pypy.org/blog">renovated blog site</a> via a pull request
to <a class="reference external" href="https://github.com/pypy/pypy.org">https://github.com/pypy/pypy.org</a></p>
<p>We would also like to thank our contributors and encourage new people to join
the project. PyPy has many layers and we need help with all of them: <a class="reference external" href="../posts/2021/05/index.html">PyPy</a>
and <a class="reference external" href="https://rpython.readthedocs.org">RPython</a> documentation improvements, tweaking popular modules to run
on PyPy, or general <a class="reference external" href="../posts/2021/05/project-ideas.html">help</a> with making RPython's JIT even better.</p>
<p>If you are a python library maintainer and use C-extensions, please consider
making a <a class="reference external" href="https://cffi.readthedocs.io">CFFI</a> / <a class="reference external" href="https://cppyy.readthedocs.io">cppyy</a> version of your library that would be performant on PyPy.
In any case both <a class="reference external" href="https://github.com/joerick/cibuildwheel">cibuildwheel</a> and the <a class="reference external" href="https://github.com/matthew-brett/multibuild">multibuild system</a> support
building wheels for PyPy.</p>
<section id="what-is-pypy"><h3>What is PyPy?</h3>
<p>PyPy is a Python interpreter, a drop-in replacement for CPython 2.7, 3.7, and
soon 3.8. It's fast (<a class="reference external" href="https://speed.pypy.org">PyPy and CPython 3.7.4</a> performance
comparison) due to its integrated tracing JIT compiler.</p>
<p>We also welcome developers of other <a class="reference external" href="https://rpython.readthedocs.io/en/latest/examples.html">dynamic languages</a> to see what RPython
can do for them.</p>
<p>This PyPy release supports:</p>
<blockquote>
<ul class="simple">
<li><p><strong>x86</strong> machines on most common operating systems
(Linux 32/64 bits, Mac OS X 64 bits, Windows 32/64 bits, OpenBSD, FreeBSD)</p></li>
<li><p>big- and little-endian variants of <strong>PPC64</strong> running Linux,</p></li>
<li><p><strong>s390x</strong> running Linux</p></li>
<li><p>64-bit <strong>ARM</strong> machines running Linux.</p></li>
</ul>
</blockquote>
<p>PyPy does support ARM 32 bit processors, but does not release binaries.</p>
</section></section>
</div>
    </article><article class="h-entry post-rest" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2021/04/ways-pypy-graphviz.html" class="u-url">Some Ways that PyPy uses Graphviz</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2021/04/ways-pypy-graphviz.html" rel="bookmark">
            <time class="published dt-published" datetime="2021-04-26T16:00:00Z" itemprop="datePublished" title="2021-04-26 16:00">2021-04-26 16:00</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <section id="some-way-that-pypy-uses-graphviz"><h2>Some way that PyPy uses Graphviz</h2>
<p>Somebody wrote this super cool thread on Twitter about using <a class="reference external" href="https://graphviz.org">Graphviz</a> to make
software visualize its internal state:</p>
<blockquote class="twitter-tweet">
<p lang="en" dir="ltr">üßµ Make yours and everybody else's lives slightly less terrible by having all your programs print out their internal stuff as pictures; ‚ú® a thread ‚ú® <a href="https://t.co/NjQ42bXN2E">pic.twitter.com/NjQ42bXN2E</a></p>‚Äî Kate (@thingskatedid) <a href="https://twitter.com/thingskatedid/status/1386077306381242371?ref_src=twsrc%5Etfw">April 24, 2021</a>
</blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>PyPy is using this approach a lot too and I collected a few screenshots of that
technique <a class="reference external" href="https://twitter.com/cfbolz/status/1386315196982079491">on Twitter</a> and I thought it would make a nice blog post too!</p>
<p>The most important view early in the project, and the way that our Graphviz
visualizations got started was that we implemented a way to look at the control
flow graphs of our RPython functions after type inference. They are in static
single information form (<a class="reference external" href="https://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.1.9976">SSI</a>), a variant of <a class="reference external" href="https://en.wikipedia.org/wiki/Static_single_assignment_form">SSA</a> form. Hovering over the
variables shows the inferred types in the footer:</p>
<img alt="/images/2021-graphviz-02-cfg-types.png" src="../images/2021-graphviz-02-cfg-types.png"><p>There's another view that shows the inferred call graph of the program:</p>
<img alt="/images/2021-graphviz-05-call-graph.png" src="../images/2021-graphviz-05-call-graph.png"><p>A related viewer shows the inferred class hierarchy (in this case the exception
hierarchy) and you can focus on a single class, which will show you its base
classes and all the methods and instance attributes that were found:</p>
<img alt="/images/2021-graphviz-03-classhier.png" src="../images/2021-graphviz-03-classhier.png"><img alt="/images/2021-graphviz-04-classhier-detailed.png" src="../images/2021-graphviz-04-classhier-detailed.png"><p>We also have a view to show us the traces that are produced by the tracing JIT
tests. this viewer doesn't really scale to the big traces that the full Python
interpreter produces, but it's really useful during testing:</p>
<img alt="/images/2021-graphviz-06-trace.png" src="../images/2021-graphviz-06-trace.png"><p>Then there are more traditional tree views, eg here is a parse tree for a small
piece of Python source code:</p>
<img alt="/images/2021-graphviz-07-parse-tree.png" src="../images/2021-graphviz-07-parse-tree.png"><p>Parsing-related we have visualized the <a class="reference external" href="https://www.pypy.org/posts/2008/01/visualizing-python-tokenizer-5020282079473796926.html">DFAs of the parser</a> in the past,
though the code is unfortunately lost.</p>
<p>All these visualizations are made by walking the relevant data structures and
producing a Graphviz input file using a bit of string manipulation, which is
quite easy to do. Knowing a bit of Graphviz is a really useful skill, it's
super easy to make throwaway visualizations.</p>
<p>For example here is a one-off thing I did when debugging our <a class="reference external" href="https://morepypy.blogspot.com/2019/10/pypys-new-json-parser.html">JSON parser</a> to
show the properties of the objects used in a huge example json file:</p>
<img alt="/images/2021-graphviz-08-json-parser.png" src="../images/2021-graphviz-08-json-parser.png"><p>On top of graphviz, we have a custom tool called the <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/tree/branch/default/dotviewer">dotviewer</a>, which is
written in Python and uses <a class="reference external" href="https://pygame.org">Pygame</a> to give you a zoomable, pannable, searchable
way to look at huge Graphviz graphs. All the images in this post are
screenshots of that tool. In its simplest form it takes any .dot files as
input.</p>
<p>Here's a small video dotviewer, moving around and searching in the json graph.
By writing a bit of extra Python code the dotviewer can also be extended to add
hyperlinks in the graphs to navigate to different views (for example, we did
that for the callgraphs above).</p>
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/SsTmJ5_Yzh8" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><p>All in all this is a really powerful approach to understand the behaviour of
some of code, or when debugging complicated problems and we have gotten a
huge amount of milage out of this over the years. It can be seen as an instance
of <a class="reference external" href="https://moldabledevelopment.com/">moldable development</a> ("a way of programming through which you construct
custom tools for each problem"). And it's really easy to get into! The Graphviz
language is quite a simple text-based language that can be applied to a huge
amount of different visualization situations.</p>
</section>
</div>
    </article><article class="h-entry post-rest" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2021/04/pypy-v734-release-of-python-27-and-37.html" class="u-url">PyPy v7.3.4: release of python 2.7 and 3.7</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/the-pypy-team.html">The PyPy Team</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2021/04/pypy-v734-release-of-python-27-and-37.html" rel="bookmark">
            <time class="published dt-published" datetime="2021-04-08T05:53:45Z" itemprop="datePublished" title="2021-04-08 05:53">2021-04-08 05:53</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <section id="pypy-v7-3-4-release-of-python-2-7-and-3-7"><h2>PyPy v7.3.4: release of python 2.7 and 3.7</h2>
<p>The PyPy team is proud to release the version 7.3.4 of PyPy, which includes
two different interpreters:</p>
<blockquote>
<ul class="simple">
<li><p>PyPy2.7, which is an interpreter supporting the syntax and the features of
Python 2.7 including the stdlib for CPython 2.7.18+ (the <code class="docutils literal">+</code> is for
backported security updates)</p></li>
<li><p>PyPy3.7,  which is an interpreter supporting the syntax and the features of
Python 3.7, including the stdlib for CPython 3.7.10. We no longer refer to
this as beta-quality as the last incompatibilities with CPython (in the
<code class="docutils literal">re</code> module) have been fixed.</p></li>
</ul>
</blockquote>
<p>We are no longer releasing a Python3.6 version, as we focus on updating to
Python 3.8. We have begun streaming the advances towards this goal on Saturday
evenings European time on <a class="reference external" href="https://www.twitch.tv/pypyproject">https://www.twitch.tv/pypyproject</a>. If Python3.6 is
important to you, please reach out as we could offer sponsored longer term
support.</p>
<p>The two interpreters are based on much the same codebase, thus the multiple
release. This is a micro release, all APIs are compatible with the other 7.3
releases. Highlights of the release include binary <strong>Windows 64</strong> support,
faster numerical instance fields, and a preliminary HPy backend.</p>
<p>A new contributor (Ondrej Baranoviƒç - thanks!) took us up on the challenge to get
<a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/2073#note_141389">windows 64-bit</a> support.  The work has been merged and for the first time we
are releasing a 64-bit Windows binary package.</p>
<p>The release contains the biggest change to <a class="reference external" href="https://www.pypy.org/posts/2010/11/efficiently-implementing-python-objects-3838329944323946932.html">PyPy's implementation of the
instances of user-defined classes</a> in many years. The optimization was
motivated by the report of performance problems running a <a class="reference external" href="https://github.com/paugier/nbabel">numerical particle
emulation</a>. We implemented an optimization that stores <code class="docutils literal">int</code> and <code class="docutils literal">float</code>
instance fields in an unboxed way, as long as these fields are type-stable
(meaning that the same field always stores the same type, using the principle
of <a class="reference external" href="https://www.csl.cornell.edu/~cbatten/pdfs/cheng-type-freezing-cgo2020.pdf">type freezing</a>). This gives significant performance improvements on
numerical pure-Python code, and other code where instances store many integers
or floating point numbers.</p>
<p>There were also a number of optimizations for methods around strings and bytes,
following user reported performance problems. If you are unhappy with PyPy's
performance on some code of yours, please report <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/">an issue</a>!</p>
<p>A major new feature is prelminary support for the Universal mode of HPy: a
new way of writing c-extension modules to totally encapsulate <code class="docutils literal">PyObject*</code>.
The goal, as laid out in the <a class="reference external" href="https://hpy.readthedocs.io/en/latest/">HPy documentation</a> and recent <a class="reference external" href="https://hpyproject.org/blog/posts/2021/03/hello-hpy/">HPy blog post</a>,
is to enable a migration path
for c-extension authors who wish their code to be performant on alternative
interpreters like <a class="reference external" href="https://github.com/graalvm/graalpython">GraalPython</a> (written on top of the Java virtual machine),
<a class="reference external" href="https://github.com/RustPython/RustPython">RustPython</a>, and PyPy. Thanks to Oracle and IBM for sponsoring work on HPy.</p>
<p>Support for the <a class="reference external" href="https://vmprof.readthedocs.io/en/latest/">vmprof</a> statistical profiler has been extended to ARM64 via a
built-in backend.</p>
<p>Several issues exposed in the 7.3.3 release were fixed. Many of them came from the
great work ongoing to ship PyPy-compatible binary packages in <a class="reference external" href="https://conda-forge.org/blog//2020/03/10/pypy">conda-forge</a>.
A big shout out to them for taking this on.</p>
<p>Development of PyPy takes place on <a class="reference external" href="https://foss.heptapod.net/pypy/pypy">https://foss.heptapod.net/pypy/pypy</a>.
We have seen an increase in the number of drive-by contributors who are able to
use gitlab + mercurial to create merge requests.</p>
<p>The <a class="reference external" href="https://cffi.readthedocs.io">CFFI</a> backend has been updated to version 1.14.5 and the <a class="reference external" href="https://cppyy.readthedocs.io">cppyy</a> backend
to 1.14.2. We recommend using CFFI rather than C-extensions to interact with C,
and using cppyy for performant wrapping of C++ code for Python.</p>
<p>As always, we strongly recommend updating to the latest versions. Many fixes
are the direct result of end-user bug reports, so please continue reporting
issues as they crop up.</p>
<p>You can find links to download the v7.3.4 releases here:</p>
<blockquote>
<p><a class="reference external" href="https://pypy.org/download.html">https://pypy.org/download.html</a></p>
</blockquote>
<p>We would like to thank our donors for the continued support of the PyPy
project. If PyPy is not quite good enough for your needs, we are available for
direct consulting work. If PyPy is helping you out, we would love to hear about
it and encourage submissions to our <a class="reference external" href="https://pypy.org/blog">renovated blog site</a> via a pull request
to <a class="reference external" href="https://github.com/pypy/pypy.org">https://github.com/pypy/pypy.org</a></p>
<p>We would also like to thank our contributors and encourage new people to join
the project. PyPy has many layers and we need help with all of them: <a class="reference external" href="../posts/2021/04/index.html">PyPy</a>
and <a class="reference external" href="https://rpython.readthedocs.org">RPython</a> documentation improvements, tweaking popular modules to run
on PyPy, or general <a class="reference external" href="../posts/2021/04/project-ideas.html">help</a> with making RPython's JIT even better. Since the
previous release, we have accepted contributions from 10 new contributors,
thanks for pitching in, and welcome to the project!</p>
<p>If you are a python library maintainer and use C-extensions, please consider
making a cffi / cppyy version of your library that would be performant on PyPy.
In any case both <a class="reference external" href="https://github.com/joerick/cibuildwheel">cibuildwheel</a> and the <a class="reference external" href="https://github.com/matthew-brett/multibuild">multibuild system</a> support
building wheels for PyPy.</p>
<section id="what-is-pypy"><h3>What is PyPy?</h3>
<p>PyPy is a Python interpreter, a drop-in replacement for CPython 2.7, 3.7, and
soon 3.8. It's fast (<a class="reference external" href="https://speed.pypy.org">PyPy and CPython 3.7.4</a> performance
comparison) due to its integrated tracing JIT compiler.</p>
<p>We also welcome developers of other <a class="reference external" href="https://rpython.readthedocs.io/en/latest/examples.html">dynamic languages</a> to see what RPython
can do for them.</p>
<p>This PyPy release supports:</p>
<blockquote>
<ul class="simple">
<li><p><strong>x86</strong> machines on most common operating systems
(Linux 32/64 bits, Mac OS X 64 bits, Windows 32/64 bits, OpenBSD, FreeBSD)</p></li>
<li><p>big- and little-endian variants of <strong>PPC64</strong> running Linux,</p></li>
<li><p><strong>s390x</strong> running Linux</p></li>
<li><p>64-bit <strong>ARM</strong> machines running Linux.</p></li>
</ul>
</blockquote>
<p>PyPy does support ARM 32 bit processors, but does not release binaries.</p>
</section><section id="what-else-is-new"><h3>What else is new?</h3>
<p>For more information about the 7.3.4 release, see the <a class="reference external" href="https://doc.pypy.org/en/latest/release-v7.3.4.html#changelog">full changelog</a>.</p>
<p>Please update, and continue to help us make PyPy better.</p>
<p>Cheers,
The PyPy team</p>
</section></section>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2021/03/new-hpy-blog.html" class="u-url">New HPy blog</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/antocuni.html">antocuni</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2021/03/new-hpy-blog.html" rel="bookmark">
            <time class="published dt-published" datetime="2021-03-29T14:00:00Z" itemprop="datePublished" title="2021-03-29 14:00">2021-03-29 14:00</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <div>
<p>Regular readers of this blog
<a href="../posts/2021/03/posts/2019/12/hpy-kick-off-sprint-report-1840829336092490938.html">already know</a>
about <a href="https://hpyproject.org">HPy</a>, a project which aims to develop a new C
API for Python to make it easier/faster to support C extensions on alternative
Python implementations, including PyPy.</p>
<p>The HPy team just published the
<a href="https://hpyproject.org/blog/posts/2021/03/hello-hpy/">first post</a> of HPy new
blog, so if you are interested in its development, make sure to check it out!</p>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2021/03/pypys-blog-has-moved.html" class="u-url">PyPy's blog has moved</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/mattip.html">mattip</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2021/03/pypys-blog-has-moved.html" rel="bookmark">
            <time class="published dt-published" datetime="2021-03-09T11:03:09Z" itemprop="datePublished" title="2021-03-09 11:03">2021-03-09 11:03</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <div>
<p>For many years, PyPy has been publishing blog posts at
<a href="https://morepypy.blogspot.com">https://morepypy.blogspot.com</a>. From now on,
the posts will be here, at <a href="https://pypy.org/blog">https://pypy.org/blog</a>. The
RSS feed is <a href="https://pypy.org/rss.xml">https://pypy.org/rss.xml</a>. The original
content has been migrated to the newer site, including comments.</p>
<p class="more"><a href="../posts/2021/03/pypys-blog-has-moved.html">Read more‚Ä¶</a></p>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2020/12/mac-meets-arm64-940822335619099039.html" class="u-url">Mac meets Arm64</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/the-pypy-team.html">The PyPy Team</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2020/12/mac-meets-arm64-940822335619099039.html" rel="bookmark">
            <time class="published dt-published" datetime="2020-12-31T09:53:00Z" itemprop="datePublished" title="2020-12-31 09:53">2020-12-31 09:53</time></a>
            </p>
                <p class="commentline">8 comments</p>

        </div>
    </header><div class="p-summary entry-summary">
    <b>Looking for sponsorship</b>

<p>Apple now ships Macs which are running on an arm64 variant machine with the
latest version of MacOS, Big Sur M1.  We are getting requests for PyPy to
support this new architecture.  Here is our position on this topic (or at least
mine, Armin Rigo's), and how you can help.</p>

<p>Porting PyPy is harder than just re-running the compiler, because PyPy contains
a few big architecture-dependent "details", like the JIT compiler and the
foreign function interfaces (CFFI and ctypes).</p>

<p>Fixing the JIT compiler should not be too much work: we already support arm64,
just the Linux one.  But Apple made various details different (like the calling
conventions).  A few other parts need to be fixed too, notably CFFI and ctypes,
again because of the calling conventions.</p>

<p>Fixing that would be a reasonable amount of work.  I would do it myself for a
small amount of money.  However, the story doesn't finish here.  Obviously, the
<b>start</b> of the story would be to get ssh access to a Big Sur M1 machine.  (If at
this point you're thinking "sure, I can give you ssh access for three months",
then please read on.)  The <b>next</b> part of the story is that we need a machine
available long term.  It can be either a machine provided and maintained by a
third party, or alternatively a pot of money big enough to support the
acquision of a machine and ongoing work of one of us.</p>

<p>If we go with the provided-machine solution:  What we need isn't a lot of
resources.  Our CI requires maybe 10 GB of disk space, and a few hours of CPU
per run.  It should fit into 8 GB of RAM.  We normally do a run every night but
we can certainly lower the frequency a bit if that would help.  However, we'd
ideally like some kind of assurance that you are invested into maintaining the
machine for the next 3-5 years (I guess, see below).  We had far too many
machines that disappeared after a few months.</p>

<p>If we go with the money-supported solution: it's likely that after 3-5 years
the whole Mac base will have switched to arm64, we'll drop x86-64 support for
Mac, and we'll be back to the situation of the past where there was only one
kind of Mac machine to care about.  In the meantime, we are looking at 3-5
years of lightweight extra maintenance.  We have someone that has said he would
do it, but not for free.</p>

<p>If either of these two solutions occurs, we'll still have, I quote, "probably
some changes in distutils-type stuff to make python happy", and then some
packaging/deployment changes to support the  "universal2" architecture, i.e.
including both versions inside a single executable (which will <b>not</b> be just an
extra switch to clang, because the two versions need a different JIT backend
and so must be translated separately).</p>

<p>So, now all the factors are on the table.  We won't do the minimal "just the
JIT compiler fixes" if we don't have a plan that goes farther.  Either we get
sufficient money, and maybe support, and then we can do it quickly; or PyPy
will just remain not natively available on M1 hardware for the next 3-5 years.
We are looking forward to supporting M1, and view resources contributed by
the community as a vote of confidence in assuring the future of PyPy on this
hardware.  Contact us: <a href="mailto:pypy-dev@python.org">pypy-dev@python.org</a>, or our private mailing
list <a href="mailto:pypy-z@python.org">pypy-z@python.org</a>.</p>

<p>Thanks for reading!</p>

<p>Armin Rigo</p>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-6361512567097951643">
        <div class="comment-header">
          <a name="comment-6361512567097951643"></a>
            <span class="author">Adam Sah</span> wrote on <span class="date">2020-12-31 14:16</span>:
        </div>
        <div class="comment-content">
          <p>if you post a crowdsourcing link (e.g. gofundme, etc) I'd be happy to contribute, and now that it's hit the front page of HN, I'm sure lots of other people would join. M1 macs are pretty inexpensive.<br><br>p.s. thanks!!! for all the work - I use pypy regularly.<br></p>
        </div>
      </div>
      <div class="comment comment-4524799428654355330">
        <div class="comment-header">
          <a name="comment-4524799428654355330"></a>
            <span class="author">Joshua Herman</span> wrote on <span class="date">2020-12-31 16:47</span>:
        </div>
        <div class="comment-content">
          <p>I have an M1 MacBook Air that I could give you SSH access to but it will come to me in mid January.</p>
        </div>
      </div>
      <div class="comment comment-1098849030683393029">
        <div class="comment-header">
          <a name="comment-1098849030683393029"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2020-12-31 21:51</span>:
        </div>
        <div class="comment-content">
          <p>ditto on the crowdsource</p>
        </div>
      </div>
      <div class="comment comment-4664589309415892523">
        <div class="comment-header">
          <a name="comment-4664589309415892523"></a>
            <span class="author">Michael</span> wrote on <span class="date">2021-01-01 00:03</span>:
        </div>
        <div class="comment-content">
          <p>You can contribute to PyPy on their Open Collective page:<br><br><a href="https://opencollective.com/pypy" rel="nofollow">https://opencollective.com/pypy</a></p>
        </div>
      </div>
      <div class="comment comment-6722182300822744347">
        <div class="comment-header">
          <a name="comment-6722182300822744347"></a>
            <span class="author">Adam Sah</span> wrote on <span class="date">2021-01-01 00:25</span>:
        </div>
        <div class="comment-content">
          <p>done.<br></p>
        </div>
      </div>
      <div class="comment comment-8608819457034357374">
        <div class="comment-header">
          <a name="comment-8608819457034357374"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2021-01-02 20:03</span>:
        </div>
        <div class="comment-content">
          <p>M1 Macs for CI are available for free for open source developers. See: https://www.macstadium.com/opensource</p>
        </div>
      </div>
      <div class="comment comment-3807754939719219692">
        <div class="comment-header">
          <a name="comment-3807754939719219692"></a>
            <span class="author">Armin Rigo</span> wrote on <span class="date">2021-01-02 20:29</span>:
        </div>
        <div class="comment-content">
          <p>@Anonymous: like many others, MacStadium is conflating "open source" with "hobbyist" by adding this clause: "Open source project may not (...)receive funding from commercial companies or organizations (NGO, education, research or governmental). (...) Contributors who are paid to work on the project are not eligible."  The point of my blog post was precisely that I won't do it for free.</p>
        </div>
      </div>
      <div class="comment comment-7290474999839814519">
        <div class="comment-header">
          <a name="comment-7290474999839814519"></a>
            <span class="author">glyph</span> wrote on <span class="date">2021-01-04 05:39</span>:
        </div>
        <div class="comment-content">
          <p>It seems like it might be worth reaching out to MacStadium about it regardless. They've got Golang, Rust, Node, NumFocus, and Monero listed on their support page https://www.macstadium.com/opensource-members which suggests to me that this language might just be a hamfistedly awkward attempt to avoid somebody at Facebook trying to get a free fleet of mac minis out of open sourcing their SDK or something.</p>
        </div>
      </div>
         </div>

</div>
</div>
<div class="sidebar">
<div>
  <h2>
    The PyPy blogposts
  </h2>
  <div>
    Create a guest post via a PR to the <a href="https://github.com/pypy/pypy.org">source repo</a>
  </div>
</div>
    <div id="global-recent-posts">
    <h2>
      Recent Posts
    </h2>
    <ul class="post-list">
      <li>
        <a href="/posts/2021/10/pypy-v737-release.html" class="listtitle">PyPy v7.3.7: bugfix release of python 3.7 and 3.8</a>
      </li>
      <li>
        <a href="/posts/2021/10/pypy-v736-release.html" class="listtitle">PyPy v7.3.6: release of python 2.7, 3.7, and 3.8</a>
      </li>
      <li>
        <a href="/posts/2021/09/jit-auto-generated-code.html" class="listtitle">Better JIT Support for Auto-Generated Python Code</a>
      </li>
      <li>
        <a href="/posts/2021/05/pypy-irc-moves-to-libera-chat.html" class="listtitle">#pypy IRC moves to Libera.Chat</a>
      </li>
      <li>
        <a href="/posts/2021/05/pypy-v735-release.html" class="listtitle">PyPy v7.3.5: bugfix release of python 2.7 and 3.7</a>
      </li>
      <li>
        <a href="/posts/2021/04/ways-pypy-graphviz.html" class="listtitle">Some Ways that PyPy uses Graphviz</a>
      </li>
      <li>
        <a href="/posts/2021/04/pypy-v734-release-of-python-27-and-37.html" class="listtitle">PyPy v7.3.4: release of python 2.7 and 3.7</a>
      </li>
      <li>
        <a href="/posts/2021/03/new-hpy-blog.html" class="listtitle">New HPy blog</a>
      </li>
      <li>
        <a href="/posts/2021/03/pypys-blog-has-moved.html" class="listtitle">PyPy's blog has moved</a>
      </li>
      <li>
        <a href="/posts/2020/12/mac-meets-arm64-940822335619099039.html" class="listtitle">Mac meets Arm64</a>
      </li>
    </ul>
  </div>

          <div id="global-archive-list">
          <h2>
            Archives
          </h2>
          <ul class="archive-level archive-level-1">
            <li><a class="reference" href="/2007/">2007</a> (19)
            </li>
            <li><a class="reference" href="/2008/">2008</a> (62)
            </li>
            <li><a class="reference" href="/2009/">2009</a> (38)
            </li>
            <li><a class="reference" href="/2010/">2010</a> (44)
            </li>
            <li><a class="reference" href="/2011/">2011</a> (43)
            </li>
            <li><a class="reference" href="/2012/">2012</a> (44)
            </li>
            <li><a class="reference" href="/2013/">2013</a> (46)
            </li>
            <li><a class="reference" href="/2014/">2014</a> (22)
            </li>
            <li><a class="reference" href="/2015/">2015</a> (20)
            </li>
            <li><a class="reference" href="/2016/">2016</a> (20)
            </li>
            <li><a class="reference" href="/2017/">2017</a> (13)
            </li>
            <li><a class="reference" href="/2018/">2018</a> (12)
            </li>
            <li><a class="reference" href="/2019/">2019</a> (12)
            </li>
            <li><a class="reference" href="/2020/">2020</a> (9)
            </li>
            <li><a class="reference" href="/2021/">2021</a> (9)
            </li>
          </ul>
        </div>


          <div id="global-tag-list">
          <h2>
            Tags
          </h2>
          <ul>
            <li><a class="reference" href="/categories/arm.html">arm</a> (2)</li>
            <li><a class="reference" href="/categories/cli.html">cli</a> (1)</li>
            <li><a class="reference" href="/categories/compiler.html">compiler</a> (1)</li>
            <li><a class="reference" href="/categories/cpyext.html">cpyext</a> (3)</li>
            <li><a class="reference" href="/categories/cpython.html">CPython</a> (3)</li>
            <li><a class="reference" href="/categories/ep2008.html">ep2008</a> (1)</li>
            <li><a class="reference" href="/categories/extension-modules.html">extension modules</a> (2)</li>
            <li><a class="reference" href="/categories/gc.html">gc</a> (1)</li>
            <li><a class="reference" href="/categories/graalpython.html">GraalPython</a> (1)</li>
            <li><a class="reference" href="/categories/hpy.html">hpy</a> (1)</li>
            <li><a class="reference" href="/categories/heptapod.html">Heptapod</a> (1)</li>
            <li><a class="reference" href="/categories/jit.html">jit</a> (18)</li>
            <li><a class="reference" href="/categories/jython.html">jython</a> (1)</li>
            <li><a class="reference" href="/categories/kcachegrind.html">kcachegrind</a> (1)</li>
            <li><a class="reference" href="/categories/numpy.html">numpy</a> (24)</li>
            <li><a class="reference" href="/categories/parser.html">parser</a> (1)</li>
            <li><a class="reference" href="/categories/profiling.html">profiling</a> (1)</li>
            <li><a class="reference" href="/categories/pypy.html">pypy</a> (6)</li>
            <li><a class="reference" href="/categories/pypy3.html">pypy3</a> (16)</li>
            <li><a class="reference" href="/categories/pyqt4.html">PyQt4</a> (1)</li>
            <li><a class="reference" href="/categories/release.html">release</a> (52)</li>
            <li><a class="reference" href="/categories/releasecffi.html">releasecffi</a> (3)</li>
            <li><a class="reference" href="/categories/releaserevdb.html">releaserevdb</a> (1)</li>
            <li><a class="reference" href="/categories/releasestm.html">releasestm</a> (1)</li>
            <li><a class="reference" href="/categories/revdb.html">revdb</a> (1)</li>
            <li><a class="reference" href="/categories/roadmap.html">roadmap</a> (1)</li>
            <li><a class="reference" href="/categories/rpyc.html">RPyC</a> (1)</li>
            <li><a class="reference" href="/categories/speed.html">speed</a> (3)</li>
            <li><a class="reference" href="/categories/sponsors.html">sponsors</a> (7)</li>
            <li><a class="reference" href="/categories/sprint.html">sprint</a> (3)</li>
            <li><a class="reference" href="/categories/stm.html">stm</a> (14)</li>
            <li><a class="reference" href="/categories/sun.html">sun</a> (1)</li>
            <li><a class="reference" href="/categories/smalltalk.html">Smalltalk</a> (1)</li>
            <li><a class="reference" href="/categories/squeak.html">Squeak</a> (1)</li>
            <li><a class="reference" href="/categories/unicode.html">unicode</a> (1)</li>
            <li><a class="reference" href="/categories/valgrind.html">valgrind</a> (1)</li>
          </ul>
        </div></div>
</main>
</div>
<div style="clear: both; width: 75%; margin: 1em auto;">
        <nav class="postindexpager"><ul class="pager">
<li class="next">
                <a href="index-41.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
         
                 <footer id="footer"><p>
</p>
<div class="myfooter">
  <div>
    <img src="../images/pypy-logo-nav-grey.png" alt="PyPy Logo">
</div>
  <div class="logotext">
    ¬†Contents ¬© 2021 <a href="mailto:pypy-dev@pypy.org">The PyPy Team</a>
    Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a> 
  </div>
  <div style="margin-left: auto">
  <a href="../rss.xml">RSS feed</a>
</div>

            
        

    </div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" crossorigin="anonymous"></script><script src="../assets/js/styles.js"></script></footer>
</body>
</html>
